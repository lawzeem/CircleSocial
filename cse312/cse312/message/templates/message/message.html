{% extends 'base.html' %}

{% load static %}

{% block title %}Message{% endblock %}

{% block body %}
<ul id='message-items'>
{% for message in object.ChatMessage_set.all %}

<li>{{ message.message }} via {{ message.user }}</li>

{% endfor %}
</ul>
  <div class="section no-pad-bot" id="index-banner">
    <div class="container row">
      <br>
      <div class="card row col m10 offset-m1 s12">
        <h1 class="header center black-text">Message</h1>
        {% csrf_token %}
        <!-- <br><br><br><br><br><br><br><br><br><br><br><br> -->
        <div class="row">
          <div class="row center col s12">
            <div class="row">
              <div class="row center col s9 offset-s1">
                <div>
                  <form id='form' method='POST'> {% csrf_token %}
                    {% for message in object.ChatMessage_set.all %}

                    <li>{{ message.message }} via {{ message.user }}</li>

                    {% endfor %}
                    <input type="text" name="message" class="form-control" required="" id="id_message">
                    
                    <input id="message" placeholder="Type A Message" type='submit' class='btn btn-primary'/>
                  </form>
                </div>  


                <!-- <input id="message" placeholder="Type A Message" class="validate"> -->
              </div>
              <div class="row center col s1">
                <a href="#" id="button" class="btn-floating waves-effect waves-light blue"><i class="material-icons right">send</i></a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/reconnecting-websocket/1.0.0/reconnecting-websocket.min.js"></script>
<script type="text/javascript">
  var loc = window.location
  var inMess = $("#message")
  var ws = 'ws://'
  if(loc.protocol == 'https'){
    ws = 'wss://'
  }

  var endPoint = ws + loc.host + loc.pathname
  var socket = new ReconnectingWebSocket(endPoint)

  socket.onmessage = function(e){
    console.log("message",e)
  }
  socket.onopen = function(e){
    console.log("open",e)
    inMess.submit(function(event){
      event.preventDefault()
      text = inMess.val()
      socket.send(JSON.stringify({'message':text}))
      inMess.val("Type A Message")
    })
  }
  socket.onerror = function(e){
    console.log("error",e)
  }
  socket.onclose = function(e){
    console.log("close",e)
  }


</script>
{% endblock %}
